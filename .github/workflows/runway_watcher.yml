name: Vogue Runway Watcher

on:
  schedule:
    # Daily at 07:00 UTC (~08:00 Madrid winter / ~09:00 summer)
    - cron: "0 7 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  watch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Detect new seasons
        id: detect
        run: |
          set +e
          python scripts/watch_seasons.py
          code=$?
          echo "exit_code=$code" >> $GITHUB_OUTPUT
          exit 0

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Prepare email content (ONLY if new seasons)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Prepare email content
        id: email
        if: steps.detect.outputs.exit_code == '1'
        run: |
          python - << 'PY' >> "$GITHUB_OUTPUT"
          import json
          from pathlib import Path

          BASE = "https://stefano99977.github.io/vogue-runway-watcher/"

          data = json.loads(Path("data/new_seasons.json").read_text(encoding="utf-8"))
          seasons = data.get("new_seasons", [])

          seasons_str = ", ".join(seasons)
          files_str = ", ".join([f"{s}.html" for s in seasons])
          links = "\n".join([f"- {BASE}seasons/{s}.html" for s in seasons])

          print(f"seasons={seasons_str}")
          print(f"files={files_str}")
          print("links<<EOF")
          print(links)
          print("EOF")
          print(f"index={BASE}")
          PY

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Process new seasons
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Process new seasons (scrape â†’ build gallery â†’ build index)
        if: steps.detect.outputs.exit_code == '1'
        run: |
          python - << 'PY'
          import json, sys, subprocess
          from pathlib import Path

          new_file = Path("data/new_seasons.json")
          if not new_file.exists():
              raise SystemExit("Expected data/new_seasons.json but file not found.")

          new = json.loads(new_file.read_text(encoding="utf-8")).get("new_seasons", [])
          if not new:
              print("No new seasons listed; nothing to do.")
              raise SystemExit(0)

          for season in new:
              # 1) Scrape season â†’ CSV
              subprocess.check_call([sys.executable, "scripts/scrape_season.py", season])

              # 2) Build gallery â†’ HTML (docs/)
              csv_path = f"data/seasons/{season}.csv"
              html_path = f"docs/seasons/{season}.html"
              title = f"Vogue {season.replace('-', ' ').title()} â€” Image Gallery"
              subprocess.check_call([
                  sys.executable,
                  "scripts/build_gallery.py",
                  csv_path,
                  html_path,
                  title
              ])

          # 3) Rebuild index â†’ docs/index.html
          subprocess.check_call([sys.executable, "scripts/build_index.py"])
          PY

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Commit changes
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Commit and push changes
        if: steps.detect.outputs.exit_code != '2'
        run: |
          git config user.name "runway-bot"
          git config user.email "runway-bot@users.noreply.github.com"

          git add -A
          git commit -m "Update Vogue watcher state/output" || exit 0
          git push

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Email notification (ONLY after successful push)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Email notification â€“ new Vogue season added
        if: steps.detect.outputs.exit_code == '1'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          secure: false
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          to: ${{ secrets.EMAIL_TO }}
          from: ${{ secrets.EMAIL_FROM }}
          subject: "ðŸ†• New Vogue runway season published"
          body: |
            A new Vogue runway season has been detected and published.

            Season(s):
            ${{ steps.email.outputs.seasons }}

            File(s):
            ${{ steps.email.outputs.files }}

            Gallery link(s):
            ${{ steps.email.outputs.links }}

            Index:
            ${{ steps.email.outputs.index }}
